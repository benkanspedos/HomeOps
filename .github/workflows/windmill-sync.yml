name: Windmill Sync (Cloudflare-Protected)

on:
  push:
    branches:
      - master
    paths:
      - 'windmill/**'
      - '.github/workflows/windmill-sync.yml'
  workflow_dispatch:

env:
  WINDMILL_URL: https://windmill.dealsniperpro.io
  WINDMILL_WORKSPACE: homeops

jobs:
  sync-to-windmill:
    name: Sync to Windmill (via Cloudflare Access)
    runs-on: ubuntu-latest

    steps:
      - name: Checkout repository
        uses: actions/checkout@v4

      - name: Test Cloudflare Access connectivity
        run: |
          echo "Testing connectivity to Windmill through Cloudflare Access..."

          response=$(curl -s -w "\n%{http_code}" \
            -H "CF-Access-Client-Id: ${{ secrets.CLOUDFLARE_CLIENT_ID }}" \
            -H "CF-Access-Client-Secret: ${{ secrets.CLOUDFLARE_CLIENT_SECRET }}" \
            "${WINDMILL_URL}/api/version" 2>&1)

          http_code=$(echo "$response" | tail -n1)
          body=$(echo "$response" | sed '$d')

          echo "HTTP Status: $http_code"
          echo "Response Body: $body"

          if [ "$http_code" -eq 200 ]; then
            echo "✅ Successfully connected to Windmill through Cloudflare Access"
          elif [ "$http_code" -eq 403 ]; then
            echo "❌ Cloudflare Access denied (403 Forbidden)"
            exit 1
          else
            echo "❌ Unexpected response code: $http_code"
            exit 1
          fi

      - name: Authenticate with Windmill
        run: |
          echo "Authenticating with Windmill..."

          login_response=$(curl -s -w "\n%{http_code}" -X POST \
            -H "Content-Type: application/json" \
            -H "CF-Access-Client-Id: ${{ secrets.CLOUDFLARE_CLIENT_ID }}" \
            -H "CF-Access-Client-Secret: ${{ secrets.CLOUDFLARE_CLIENT_SECRET }}" \
            -d "{\"email\":\"${{ secrets.WINDMILL_EMAIL }}\",\"password\":\"${{ secrets.WINDMILL_PASSWORD }}\"}" \
            "${WINDMILL_URL}/api/auth/login")

          http_code=$(echo "$login_response" | tail -n1)
          body=$(echo "$login_response" | sed '$d')

          echo "HTTP Status: $http_code"
          echo "Login response (first 200 chars): ${body:0:200}"

          if [ "$http_code" -ne 200 ]; then
            echo "❌ Authentication failed with HTTP $http_code"
            echo "Full response: $body"
            exit 1
          fi

          # Try parsing as JSON first
          token=$(echo "$body" | jq -r '.token // empty' 2>/dev/null || true)

          # If no token from JSON, the response might be the token itself (plain text)
          if [ -z "$token" ] || [ "$token" = "null" ]; then
            # Remove any whitespace and use the body directly as token
            token=$(echo "$body" | tr -d '[:space:]' || true)

            if [ -z "$token" ]; then
              echo "❌ Failed to extract authentication token"
              echo "Full response: $body"
              exit 1
            fi

            echo "ℹ️  Token received as plain text (not JSON)"
          else
            echo "ℹ️  Token received as JSON"
          fi

          echo "✅ Successfully authenticated"
          echo "Token length: ${#token}"
          echo "WINDMILL_TOKEN=$token" >> $GITHUB_ENV

      - name: Sync scripts to Windmill using API
        working-directory: ./windmill
        run: |
          echo "Syncing scripts to Windmill workspace: $WINDMILL_WORKSPACE"
          echo "Using token: ${WINDMILL_TOKEN:0:10}..."

          # Check if f/ directory exists
          if [ ! -d "f" ]; then
            echo "❌ Directory 'f/' not found in $(pwd)"
            ls -la
            exit 1
          fi

          # Find all TypeScript, Python, and Go files in f/ directory
          script_count=0
          find f -type f \( -name "*.ts" -o -name "*.py" -o -name "*.go" \) | while read script; do
            script_count=$((script_count + 1))
            echo "[$script_count] Processing: $script"

            # Extract script path for Windmill (remove extension)
            script_path=$(echo "$script" | sed 's/\.[^.]*$//')

            # Read script content and escape for JSON
            content=$(cat "$script" | jq -Rs .)

            # Determine language from extension
            if [[ "$script" == *.ts ]]; then
              language="deno"
            elif [[ "$script" == *.py ]]; then
              language="python3"
            elif [[ "$script" == *.go ]]; then
              language="go"
            fi

            # Create/update script via API
            echo "   Syncing to path: $script_path (language: $language)"

            response=$(curl -s -w "\n%{http_code}" -X POST \
              -H "Authorization: Bearer $WINDMILL_TOKEN" \
              -H "Content-Type: application/json" \
              -H "CF-Access-Client-Id: ${{ secrets.CLOUDFLARE_CLIENT_ID }}" \
              -H "CF-Access-Client-Secret: ${{ secrets.CLOUDFLARE_CLIENT_SECRET }}" \
              -d "{
                \"path\": \"$script_path\",
                \"content\": $content,
                \"summary\": \"Synced from GitHub Actions\",
                \"language\": \"$language\"
              }" \
              "${WINDMILL_URL}/api/w/$WINDMILL_WORKSPACE/scripts/create")

            http_code=$(echo "$response" | tail -n1)
            body=$(echo "$response" | sed '$d')

            echo "   HTTP Status: $http_code"

            # Check response
            if [ "$http_code" -eq 200 ] || [ "$http_code" -eq 201 ]; then
              if echo "$body" | jq -e '.path' >/dev/null 2>&1; then
                echo "   ✅ Successfully synced: $script_path"
              else
                echo "   ⚠️  Response: ${body:0:200}"
              fi
            else
              echo "   ❌ Failed with HTTP $http_code"
              echo "   Response: ${body:0:300}"
            fi
          done

          echo "✅ Sync completed"

      - name: Verify deployment
        run: |
          echo "Verifying scripts in workspace..."

          scripts=$(curl -s \
            -H "Authorization: Bearer $WINDMILL_TOKEN" \
            -H "CF-Access-Client-Id: ${{ secrets.CLOUDFLARE_CLIENT_ID }}" \
            -H "CF-Access-Client-Secret: ${{ secrets.CLOUDFLARE_CLIENT_SECRET }}" \
            "${WINDMILL_URL}/api/w/$WINDMILL_WORKSPACE/scripts/list")

          echo "Deployed scripts:"
          echo "$scripts" | jq -r '.[] | .path' || echo "$scripts"

          script_count=$(echo "$scripts" | jq '. | length' 2>/dev/null || echo "0")
          echo "Total scripts: $script_count"

      - name: Summary
        if: always()
        run: |
          echo "## Windmill Sync Summary" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "- **Workspace**: $WINDMILL_WORKSPACE" >> $GITHUB_STEP_SUMMARY
          echo "- **URL**: $WINDMILL_URL" >> $GITHUB_STEP_SUMMARY
          echo "- **Status**: ${{ job.status }}" >> $GITHUB_STEP_SUMMARY
