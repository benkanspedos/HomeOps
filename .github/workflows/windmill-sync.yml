name: Windmill IaC Sync

on:
  push:
    branches:
      - master
    paths:
      - 'windmill/**'
      - '.github/workflows/windmill-sync.yml'
  workflow_dispatch:

jobs:
  sync:
    runs-on: ubuntu-latest
    steps:
      - name: Checkout Code
        uses: actions/checkout@v3

      # We don't even need Node.js anymore!
      
      - name: Install Official Windmill Binary
        run: |
          # Download the latest standalone binary (Rust version)
          curl -L "https://github.com/windmill-labs/windmill/releases/latest/download/windmill-linux-amd64" -o wmill
          chmod +x wmill
          sudo mv wmill /usr/local/bin/

      - name: Sync to Windmill
        env:
          WMILL_TOKEN: ${{ secrets.WMILL_TOKEN }}
          CF_ID: ${{ secrets.CLOUDFLARE_CLIENT_ID }}
          CF_SECRET: ${{ secrets.CLOUDFLARE_CLIENT_SECRET }}
        run: |
          # 1. Clean Variables
          CLEAN_ID=$(echo "$CF_ID" | tr -d '[:space:]')
          CLEAN_SECRET=$(echo "$CF_SECRET" | tr -d '[:space:]')

          # 2. Set Headers for the Binary
          # The Rust binary reliably picks up this env var
          export WMILL_HEADERS="{\"CF-Access-Client-Id\": \"$CLEAN_ID\", \"CF-Access-Client-Secret\": \"$CLEAN_SECRET\"}"

          # 3. Configure Workspace
          wmill workspace add homeops homeops https://windmill.dealsniperpro.io --token $WMILL_TOKEN

          # 4. Push Code
          wmill sync push