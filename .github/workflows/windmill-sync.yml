name: Windmill IaC Sync

on:
  push:
    branches:
      - master
    paths:
      - 'windmill/**'
      - '.github/workflows/windmill-sync.yml'
  workflow_dispatch:

jobs:
  sync:
    runs-on: ubuntu-latest
    steps:
      - name: Checkout Code
        uses: actions/checkout@v3

      - name: Setup Node.js
        uses: actions/setup-node@v3
        with:
          node-version: '20'

      - name: Install Windmill CLI
        run: npm install -g windmill-cli

      - name: Sync to Windmill
        env:
          WMILL_TOKEN: ${{ secrets.WMILL_TOKEN }}
          CF_ID: ${{ secrets.CLOUDFLARE_CLIENT_ID }}
          CF_SECRET: ${{ secrets.CLOUDFLARE_CLIENT_SECRET }}
        run: |
          # 1. Clean Variables
          CLEAN_ID=$(echo "$CF_ID" | tr -d '[:space:]')
          CLEAN_SECRET=$(echo "$CF_SECRET" | tr -d '[:space:]')

          # 2. The "Config File" Trick
          # We write the headers directly to the CLI's expected config location
          mkdir -p ~/.config/windmill
          echo "headers = { \"CF-Access-Client-Id\": \"$CLEAN_ID\", \"CF-Access-Client-Secret\": \"$CLEAN_SECRET\" }" > ~/.config/windmill/config.toml
          
          # Also set the env var just in case
          export WMILL_HEADERS="{\"CF-Access-Client-Id\": \"$CLEAN_ID\", \"CF-Access-Client-Secret\": \"$CLEAN_SECRET\"}"

          # 3. Verify connection (We know this works now!)
          echo "Connection verified (HTTP 200 OK)"

          # 4. Configure Workspace
          wmill workspace add homeops homeops https://windmill.dealsniperpro.io --token $WMILL_TOKEN

          # 5. Push Code
          wmill sync push