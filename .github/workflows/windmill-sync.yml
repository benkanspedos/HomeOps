name: Windmill IaC Sync

on:
  push:
    branches:
      - master
    paths:
      - 'windmill/**'
      - '.github/workflows/windmill-sync.yml'
  workflow_dispatch:

jobs:
  sync:
    runs-on: ubuntu-latest
    steps:
      - name: Checkout Code
        uses: actions/checkout@v3

      - name: Setup Node.js
        uses: actions/setup-node@v3
        with:
          node-version: '20'

      - name: Install Windmill CLI (Official NPM)
        run: npm install -g windmill-cli

      - name: Sync to Windmill
        env:
          WMILL_TOKEN: ${{ secrets.WMILL_TOKEN }}
          CF_ID: ${{ secrets.CLOUDFLARE_CLIENT_ID }}
          CF_SECRET: ${{ secrets.CLOUDFLARE_CLIENT_SECRET }}
        run: |
          # 1. Clean Variables
          CLEAN_ID=$(echo "$CF_ID" | tr -d '[:space:]')
          CLEAN_SECRET=$(echo "$CF_SECRET" | tr -d '[:space:]')

          # 2. Set Headers (Covering ALL formats to be safe)
          # Format A: JSON (Used by some versions)
          export WMILL_HEADERS="{\"CF-Access-Client-Id\": \"$CLEAN_ID\", \"CF-Access-Client-Secret\": \"$CLEAN_SECRET\"}"
          # Format B: String (Used by others)
          export HEADERS="CF-Access-Client-Id:$CLEAN_ID,CF-Access-Client-Secret:$CLEAN_SECRET"

          # 3. Configure Workspace
          # We use the token to authenticate with Windmill itself
          wmill workspace add homeops homeops https://windmill.dealsniperpro.io --token $WMILL_TOKEN

          # 4. Push Code
          cd windmill
          wmill sync push