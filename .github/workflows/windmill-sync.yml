name: Windmill IaC Sync

on:
  push:
    branches:
      - master
    paths:
      - 'windmill/**'
      - '.github/workflows/windmill-sync.yml'
  workflow_dispatch:

jobs:
  sync:
    runs-on: ubuntu-latest
    steps:
      - name: Checkout Code
        uses: actions/checkout@v3

      - name: Setup Node.js
        uses: actions/setup-node@v3
        with:
          node-version: '20'

      - name: Install Windmill CLI
        run: npm install -g windmill-cli

      - name: Sync to Windmill
        env:
          WMILL_TOKEN: ${{ secrets.WMILL_TOKEN }}
          CF_ID: ${{ secrets.CLOUDFLARE_CLIENT_ID }}
          CF_SECRET: ${{ secrets.CLOUDFLARE_CLIENT_SECRET }}
        run: |
          # 1. Clean Variables (Strip invisible whitespace/newlines)
          CLEAN_ID=$(echo "$CF_ID" | tr -d '[:space:]')
          CLEAN_SECRET=$(echo "$CF_SECRET" | tr -d '[:space:]')

          # 2. Debug Print (Shows first 4 chars ONLY - Safe for logs)
          echo "DEBUG: Using Client ID starting with: ${CLEAN_ID:0:4}..."

          # 3. Set Headers for CLI (Single line, strict JSON)
          export WMILL_HEADERS="{\"CF-Access-Client-Id\": \"$CLEAN_ID\", \"CF-Access-Client-Secret\": \"$CLEAN_SECRET\"}"

          # 4. Verify connection with verbose curl to see the handshake
          echo "Testing connection..."
          curl -v -f -I -H "CF-Access-Client-Id: $CLEAN_ID" \
                        -H "CF-Access-Client-Secret: $CLEAN_SECRET" \
                        https://windmill.dealsniperpro.io

          # 5. Configure Workspace
          wmill workspace add homeops homeops https://windmill.dealsniperpro.io --token $WMILL_TOKEN

          # 6. Push Code
          wmill sync push