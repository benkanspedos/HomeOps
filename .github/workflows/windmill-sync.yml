name: Windmill IaC Sync

on:
  push:
    branches:
      - master
    paths:
      - 'windmill/**'
      - '.github/workflows/windmill-sync.yml'
  workflow_dispatch:

jobs:
  sync:
    runs-on: ubuntu-latest
    steps:
      - name: Checkout Code
        uses: actions/checkout@v3

      - name: Setup Node.js
        uses: actions/setup-node@v3
        with:
          node-version: '20'

      - name: Install Windmill CLI
        run: npm install -g windmill-cli

      - name: Sync to Windmill
        env:
          # Secrets from GitHub
          WMILL_TOKEN: ${{ secrets.WMILL_TOKEN }}
          CF_ID: ${{ secrets.CLOUDFLARE_CLIENT_ID }}
          CF_SECRET: ${{ secrets.CLOUDFLARE_CLIENT_SECRET }}
          # The "Magic Variable" - formatted as a YAML block string to prevent syntax errors
          WMILL_HEADERS: |
            {"CF-Access-Client-Id": "${{ secrets.CLOUDFLARE_CLIENT_ID }}", "CF-Access-Client-Secret": "${{ secrets.CLOUDFLARE_CLIENT_SECRET }}"}
        run: |
          # 1. Verify connection (Debug step)
          echo "Testing connection to Windmill through Cloudflare..."
          # Note: The CLI uses WMILL_HEADERS automatically, but for curl we pass them manually
          curl -f -I -H "CF-Access-Client-Id: $CF_ID" \
                     -H "CF-Access-Client-Secret: $CF_SECRET" \
                     https://windmill.dealsniperpro.io

          # 2. Configure Workspace
          # Syntax: wmill workspace add <name> <id> <url> --token <token>
          wmill workspace add homeops homeops https://windmill.dealsniperpro.io --token $WMILL_TOKEN

          # 3. Push Code
          wmill sync push