name: Comprehensive Test Suite

on:
  push:
    branches: [ main, develop, 'feature/*' ]
  pull_request:
    branches: [ main, develop ]

env:
  NODE_VERSION: '18'
  PYTHON_VERSION: '3.12'

jobs:
  # Backend Unit and Integration Tests
  backend-tests:
    name: Backend Tests
    runs-on: ubuntu-latest
    
    services:
      postgres:
        image: postgres:15
        env:
          POSTGRES_PASSWORD: test
          POSTGRES_USER: test
          POSTGRES_DB: homeops_test
        options: >-
          --health-cmd pg_isready
          --health-interval 10s
          --health-timeout 5s
          --health-retries 5
        ports:
          - 5432:5432
      
      redis:
        image: redis:7
        options: >-
          --health-cmd "redis-cli ping"
          --health-interval 10s
          --health-timeout 5s
          --health-retries 5
        ports:
          - 6379:6379
    
    steps:
      - name: Checkout code
        uses: actions/checkout@v4
      
      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: ${{ env.NODE_VERSION }}
          cache: 'npm'
          cache-dependency-path: backend/package-lock.json
      
      - name: Install backend dependencies
        run: |
          cd backend
          npm ci
      
      - name: Setup test environment
        run: |
          cd backend
          cp .env.example .env.test || echo "No .env.example found"
        env:
          DATABASE_URL: postgresql://test:test@localhost:5432/homeops_test
          REDIS_URL: redis://localhost:6379
          NODE_ENV: test
      
      - name: Run database migrations
        run: |
          cd backend
          npm run migrate:test || echo "No migration script found"
      
      - name: Run unit tests
        run: |
          cd backend
          npm run test:unit -- --coverage --verbose
        env:
          NODE_ENV: test
          DATABASE_URL: postgresql://test:test@localhost:5432/homeops_test
          REDIS_URL: redis://localhost:6379
      
      - name: Run integration tests
        run: |
          cd backend
          npm run test:integration -- --coverage --verbose
        env:
          NODE_ENV: test
          DATABASE_URL: postgresql://test:test@localhost:5432/homeops_test
          REDIS_URL: redis://localhost:6379
      
      - name: Run contract tests
        run: |
          cd backend
          npm run test:contract || npm test -- --testPathPattern=contract
        env:
          NODE_ENV: test
      
      - name: Run performance tests
        run: |
          cd backend
          npm run test:performance || npm test -- --testPathPattern=performance --testTimeout=60000
        env:
          NODE_ENV: test
      
      - name: Upload backend test coverage
        uses: codecov/codecov-action@v3
        with:
          directory: backend/coverage
          flags: backend
          name: backend-coverage
          fail_ci_if_error: false

  # Frontend Unit Tests
  frontend-tests:
    name: Frontend Tests
    runs-on: ubuntu-latest
    
    steps:
      - name: Checkout code
        uses: actions/checkout@v4
      
      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: ${{ env.NODE_VERSION }}
          cache: 'npm'
      
      - name: Install frontend dependencies
        run: npm ci
      
      - name: Run frontend unit tests
        run: npm run test -- --coverage --watchAll=false --verbose
        env:
          CI: true
      
      - name: Run component tests
        run: npm run test:components || npm test -- --testPathPattern=components --watchAll=false
        env:
          CI: true
      
      - name: Run hook tests
        run: npm run test:hooks || npm test -- --testPathPattern=hooks --watchAll=false
        env:
          CI: true
      
      - name: Upload frontend test coverage
        uses: codecov/codecov-action@v3
        with:
          directory: coverage
          flags: frontend
          name: frontend-coverage
          fail_ci_if_error: false

  # Type Checking and Linting
  code-quality:
    name: Code Quality
    runs-on: ubuntu-latest
    
    steps:
      - name: Checkout code
        uses: actions/checkout@v4
      
      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: ${{ env.NODE_VERSION }}
          cache: 'npm'
      
      - name: Install dependencies
        run: npm ci
      
      - name: TypeScript type checking (Frontend)
        run: npm run type-check || npx tsc --noEmit
        continue-on-error: false
      
      - name: TypeScript type checking (Backend)
        run: |
          cd backend
          npm ci
          npm run type-check || npx tsc --noEmit
        continue-on-error: false
      
      - name: Lint frontend code
        run: npm run lint || npx eslint . --ext .ts,.tsx,.js,.jsx
        continue-on-error: false
      
      - name: Lint backend code
        run: |
          cd backend
          npm run lint || npx eslint . --ext .ts,.js
        continue-on-error: false
      
      - name: Check formatting
        run: npm run format:check || npx prettier --check .
        continue-on-error: false

  # End-to-End Tests
  e2e-tests:
    name: E2E Tests
    runs-on: ubuntu-latest
    timeout-minutes: 30
    
    services:
      postgres:
        image: postgres:15
        env:
          POSTGRES_PASSWORD: test
          POSTGRES_USER: test
          POSTGRES_DB: homeops_test
        options: >-
          --health-cmd pg_isready
          --health-interval 10s
          --health-timeout 5s
          --health-retries 5
        ports:
          - 5432:5432
      
      redis:
        image: redis:7
        options: >-
          --health-cmd "redis-cli ping"
          --health-interval 10s
          --health-timeout 5s
          --health-retries 5
        ports:
          - 6379:6379
    
    steps:
      - name: Checkout code
        uses: actions/checkout@v4
      
      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: ${{ env.NODE_VERSION }}
          cache: 'npm'
      
      - name: Install dependencies
        run: npm ci
      
      - name: Install backend dependencies
        run: |
          cd backend
          npm ci
      
      - name: Setup test environment
        run: |
          cp .env.example .env.local || echo "NEXT_PUBLIC_API_URL=http://localhost:3001" > .env.local
          cd backend
          cp .env.example .env || echo "DATABASE_URL=postgresql://test:test@localhost:5432/homeops_test" > .env
        env:
          DATABASE_URL: postgresql://test:test@localhost:5432/homeops_test
          REDIS_URL: redis://localhost:6379
          NODE_ENV: test
          NEXT_PUBLIC_API_URL: http://localhost:3001
      
      - name: Build frontend
        run: npm run build
        env:
          NEXT_PUBLIC_API_URL: http://localhost:3001
      
      - name: Install Playwright browsers
        run: npx playwright install --with-deps chromium
      
      - name: Start backend server
        run: |
          cd backend
          npm run start:test &
          sleep 10
        env:
          NODE_ENV: test
          DATABASE_URL: postgresql://test:test@localhost:5432/homeops_test
          REDIS_URL: redis://localhost:6379
          PORT: 3001
      
      - name: Start frontend server
        run: |
          npm run start &
          sleep 15
        env:
          NEXT_PUBLIC_API_URL: http://localhost:3001
          PORT: 3000
      
      - name: Wait for services
        run: |
          timeout 30 bash -c 'until curl -f http://localhost:3000; do sleep 2; done'
          timeout 30 bash -c 'until curl -f http://localhost:3001/api/health; do sleep 2; done'
      
      - name: Run E2E tests
        run: npm run test:e2e
        env:
          CI: true
          PLAYWRIGHT_BASE_URL: http://localhost:3000
      
      - name: Upload E2E test artifacts
        uses: actions/upload-artifact@v3
        if: failure()
        with:
          name: playwright-report
          path: |
            test-results/
            playwright-report/
          retention-days: 7

  # Docker Build Test
  docker-build:
    name: Docker Build Test
    runs-on: ubuntu-latest
    
    steps:
      - name: Checkout code
        uses: actions/checkout@v4
      
      - name: Set up Docker Buildx
        uses: docker/setup-buildx-action@v3
      
      - name: Test frontend Docker build
        run: docker build -f Dockerfile -t homeops:test .
      
      - name: Test backend Docker build
        run: docker build -f Dockerfile.backend -t homeops-backend:test ./backend
      
      - name: Test Docker Compose
        run: |
          cp .env.example .env || echo "NODE_ENV=test" > .env
          docker-compose -f docker-compose.yml config
          docker-compose -f docker-compose.yml build --no-cache

  # Security Scanning
  security-scan:
    name: Security Scan
    runs-on: ubuntu-latest
    
    steps:
      - name: Checkout code
        uses: actions/checkout@v4
      
      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: ${{ env.NODE_VERSION }}
          cache: 'npm'
      
      - name: Install dependencies
        run: npm ci
      
      - name: Install backend dependencies
        run: |
          cd backend
          npm ci
      
      - name: Run npm audit (Frontend)
        run: npm audit --audit-level=high
        continue-on-error: true
      
      - name: Run npm audit (Backend)
        run: |
          cd backend
          npm audit --audit-level=high
        continue-on-error: true
      
      - name: Run Snyk security scan
        uses: snyk/actions/node@master
        continue-on-error: true
        env:
          SNYK_TOKEN: ${{ secrets.SNYK_TOKEN }}
        with:
          args: --severity-threshold=high
      
      - name: Upload Snyk results
        uses: github/codeql-action/upload-sarif@v2
        if: always()
        with:
          sarif_file: snyk.sarif

  # Performance Benchmarks
  performance-benchmarks:
    name: Performance Benchmarks
    runs-on: ubuntu-latest
    
    services:
      postgres:
        image: postgres:15
        env:
          POSTGRES_PASSWORD: test
          POSTGRES_USER: test
          POSTGRES_DB: homeops_test
        options: >-
          --health-cmd pg_isready
          --health-interval 10s
          --health-timeout 5s
          --health-retries 5
        ports:
          - 5432:5432
      
      redis:
        image: redis:7
        options: >-
          --health-cmd "redis-cli ping"
          --health-interval 10s
          --health-timeout 5s
          --health-retries 5
        ports:
          - 6379:6379
    
    steps:
      - name: Checkout code
        uses: actions/checkout@v4
      
      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: ${{ env.NODE_VERSION }}
          cache: 'npm'
      
      - name: Install dependencies
        run: |
          npm ci
          cd backend && npm ci
      
      - name: Build application
        run: npm run build
        env:
          NEXT_PUBLIC_API_URL: http://localhost:3001
      
      - name: Start backend for benchmarking
        run: |
          cd backend
          npm run start:test &
          sleep 10
        env:
          NODE_ENV: test
          DATABASE_URL: postgresql://test:test@localhost:5432/homeops_test
          REDIS_URL: redis://localhost:6379
          PORT: 3001
      
      - name: Run API performance tests
        run: |
          cd backend
          npm run test:performance -- --testTimeout=120000
        env:
          NODE_ENV: test
          DATABASE_URL: postgresql://test:test@localhost:5432/homeops_test
      
      - name: Run Lighthouse CI
        run: |
          npm install -g @lhci/cli@0.12.x
          npm run start &
          sleep 15
          lhci autorun --upload.target=temporary-public-storage || echo "Lighthouse failed"
        env:
          NEXT_PUBLIC_API_URL: http://localhost:3001
          LHCI_GITHUB_APP_TOKEN: ${{ secrets.LHCI_GITHUB_APP_TOKEN }}

  # Test Summary
  test-summary:
    name: Test Summary
    runs-on: ubuntu-latest
    needs: [backend-tests, frontend-tests, code-quality, e2e-tests, docker-build, security-scan, performance-benchmarks]
    if: always()
    
    steps:
      - name: Test Results Summary
        run: |
          echo "## Test Results Summary" >> $GITHUB_STEP_SUMMARY
          echo "| Test Suite | Status |" >> $GITHUB_STEP_SUMMARY
          echo "|------------|--------|" >> $GITHUB_STEP_SUMMARY
          echo "| Backend Tests | ${{ needs.backend-tests.result == 'success' && '✅ Pass' || '❌ Fail' }} |" >> $GITHUB_STEP_SUMMARY
          echo "| Frontend Tests | ${{ needs.frontend-tests.result == 'success' && '✅ Pass' || '❌ Fail' }} |" >> $GITHUB_STEP_SUMMARY
          echo "| Code Quality | ${{ needs.code-quality.result == 'success' && '✅ Pass' || '❌ Fail' }} |" >> $GITHUB_STEP_SUMMARY
          echo "| E2E Tests | ${{ needs.e2e-tests.result == 'success' && '✅ Pass' || '❌ Fail' }} |" >> $GITHUB_STEP_SUMMARY
          echo "| Docker Build | ${{ needs.docker-build.result == 'success' && '✅ Pass' || '❌ Fail' }} |" >> $GITHUB_STEP_SUMMARY
          echo "| Security Scan | ${{ needs.security-scan.result == 'success' && '✅ Pass' || '⚠️ Warning' }} |" >> $GITHUB_STEP_SUMMARY
          echo "| Performance | ${{ needs.performance-benchmarks.result == 'success' && '✅ Pass' || '⚠️ Warning' }} |" >> $GITHUB_STEP_SUMMARY
      
      - name: Check if all tests passed
        run: |
          if [[ "${{ needs.backend-tests.result }}" == "success" && 
                "${{ needs.frontend-tests.result }}" == "success" && 
                "${{ needs.code-quality.result }}" == "success" && 
                "${{ needs.e2e-tests.result }}" == "success" && 
                "${{ needs.docker-build.result }}" == "success" ]]; then
            echo "✅ All critical tests passed!"
            exit 0
          else
            echo "❌ Some critical tests failed. Check the individual job results above."
            exit 1
          fi