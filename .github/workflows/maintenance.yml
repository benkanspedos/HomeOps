name: Maintenance and Monitoring

on:
  schedule:
    # Run daily dependency updates at 2 AM UTC
    - cron: '0 2 * * *'
    # Run weekly security scans on Sundays at 3 AM UTC
    - cron: '0 3 * * 0'
  workflow_dispatch:
    inputs:
      task:
        description: 'Maintenance task to run'
        required: true
        default: 'all'
        type: choice
        options:
          - all
          - dependency-update
          - security-scan
          - performance-check
          - cleanup

env:
  NODE_VERSION: '18'

jobs:
  # Automated dependency updates
  dependency-update:
    name: Update Dependencies
    runs-on: ubuntu-latest
    if: github.event.schedule || github.event.inputs.task == 'all' || github.event.inputs.task == 'dependency-update'
    
    steps:
      - name: Checkout code
        uses: actions/checkout@v4
        with:
          token: ${{ secrets.GITHUB_TOKEN }}
      
      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: ${{ env.NODE_VERSION }}
      
      - name: Update frontend dependencies
        run: |
          npm update
          npm audit fix --audit-level=high || echo "Some audit issues remain"
      
      - name: Update backend dependencies
        run: |
          cd backend
          npm update
          npm audit fix --audit-level=high || echo "Some audit issues remain"
      
      - name: Run tests after updates
        run: |
          npm run test -- --watchAll=false --testTimeout=30000
          cd backend && npm test -- --testTimeout=30000
      
      - name: Create Pull Request for dependency updates
        uses: peter-evans/create-pull-request@v5
        with:
          token: ${{ secrets.GITHUB_TOKEN }}
          commit-message: 'chore: update dependencies'
          title: 'Automated Dependency Update'
          body: |
            ## Automated Dependency Update
            
            This PR contains automated dependency updates.
            
            ### Changes:
            - Updated npm dependencies to latest compatible versions
            - Fixed security vulnerabilities where possible
            - Ran tests to ensure compatibility
            
            ### Testing:
            - [ ] All tests pass
            - [ ] No breaking changes detected
            - [ ] Security vulnerabilities addressed
            
            Generated by GitHub Actions on ${{ github.run_id }}
          branch: dependency-update-${{ github.run_number }}
          delete-branch: true

  # Weekly security scanning
  security-scan:
    name: Security Scan
    runs-on: ubuntu-latest
    if: github.event.schedule || github.event.inputs.task == 'all' || github.event.inputs.task == 'security-scan'
    
    steps:
      - name: Checkout code
        uses: actions/checkout@v4
      
      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: ${{ env.NODE_VERSION }}
      
      - name: Install dependencies
        run: |
          npm ci
          cd backend && npm ci
      
      - name: Run Snyk security scan
        uses: snyk/actions/node@master
        env:
          SNYK_TOKEN: ${{ secrets.SNYK_TOKEN }}
        with:
          args: --all-projects --severity-threshold=medium
      
      - name: Upload Snyk results
        uses: github/codeql-action/upload-sarif@v2
        if: always()
        with:
          sarif_file: snyk.sarif
      
      - name: Check for secrets in code
        uses: trufflesecurity/trufflehog@main
        with:
          path: ./
          base: main
          head: HEAD
      
      - name: OWASP ZAP security scan
        uses: zaproxy/action-full-scan@v0.8.0
        with:
          target: 'http://localhost:3000'
          rules_file_name: '.zap/rules.tsv'
          cmd_options: '-a'
        continue-on-error: true
      
      - name: Generate security report
        run: |
          echo "# Security Scan Report" > security-report.md
          echo "Generated on: $(date)" >> security-report.md
          echo "" >> security-report.md
          echo "## Scan Results" >> security-report.md
          echo "- Snyk scan completed" >> security-report.md
          echo "- Secret detection completed" >> security-report.md
          echo "- OWASP ZAP scan completed" >> security-report.md
          echo "" >> security-report.md
          echo "See GitHub Security tab for detailed findings." >> security-report.md
      
      - name: Upload security report
        uses: actions/upload-artifact@v3
        with:
          name: security-report
          path: security-report.md
          retention-days: 30

  # Performance monitoring
  performance-check:
    name: Performance Check
    runs-on: ubuntu-latest
    if: github.event.schedule || github.event.inputs.task == 'all' || github.event.inputs.task == 'performance-check'
    
    services:
      postgres:
        image: postgres:15
        env:
          POSTGRES_PASSWORD: test
          POSTGRES_USER: test
          POSTGRES_DB: homeops_test
        options: >-
          --health-cmd pg_isready
          --health-interval 10s
          --health-timeout 5s
          --health-retries 5
        ports:
          - 5432:5432
      
      redis:
        image: redis:7
        options: >-
          --health-cmd "redis-cli ping"
          --health-interval 10s
          --health-timeout 5s
          --health-retries 5
        ports:
          - 6379:6379
    
    steps:
      - name: Checkout code
        uses: actions/checkout@v4
      
      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: ${{ env.NODE_VERSION }}
      
      - name: Install dependencies
        run: |
          npm ci
          cd backend && npm ci
      
      - name: Build application
        run: npm run build
        env:
          NEXT_PUBLIC_API_URL: http://localhost:3001
      
      - name: Start backend server
        run: |
          cd backend
          npm run start:test &
          sleep 10
        env:
          NODE_ENV: test
          DATABASE_URL: postgresql://test:test@localhost:5432/homeops_test
          REDIS_URL: redis://localhost:6379
          PORT: 3001
      
      - name: Start frontend server
        run: |
          npm run start &
          sleep 15
        env:
          NEXT_PUBLIC_API_URL: http://localhost:3001
          PORT: 3000
      
      - name: Run performance tests
        run: |
          cd backend
          npm run test:performance -- --testTimeout=120000
        env:
          NODE_ENV: test
          DATABASE_URL: postgresql://test:test@localhost:5432/homeops_test
      
      - name: Run Lighthouse performance audit
        run: |
          npm install -g @lhci/cli@0.12.x
          lhci autorun --config=.lighthouserc.js || echo "Lighthouse audit completed with warnings"
        env:
          LHCI_GITHUB_APP_TOKEN: ${{ secrets.LHCI_GITHUB_APP_TOKEN }}
      
      - name: Analyze bundle size
        run: |
          npm run analyze || echo "Bundle analysis completed"
          du -sh .next/static/chunks/*.js | sort -hr | head -10 > bundle-analysis.txt
      
      - name: Generate performance report
        run: |
          echo "# Performance Report" > performance-report.md
          echo "Generated on: $(date)" >> performance-report.md
          echo "" >> performance-report.md
          echo "## Bundle Analysis" >> performance-report.md
          cat bundle-analysis.txt >> performance-report.md
          echo "" >> performance-report.md
          echo "## Database Query Performance" >> performance-report.md
          echo "Performance tests completed - check artifacts for details" >> performance-report.md
      
      - name: Upload performance report
        uses: actions/upload-artifact@v3
        with:
          name: performance-report
          path: |
            performance-report.md
            bundle-analysis.txt
            .lighthouseci/
          retention-days: 30

  # Database maintenance
  database-maintenance:
    name: Database Maintenance
    runs-on: ubuntu-latest
    if: github.event.schedule || github.event.inputs.task == 'all'
    
    steps:
      - name: Checkout code
        uses: actions/checkout@v4
      
      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: ${{ env.NODE_VERSION }}
      
      - name: Install dependencies
        run: |
          cd backend
          npm ci
      
      - name: Database health check
        run: |
          cd backend
          node -e "
            const { Client } = require('pg');
            const client = new Client({ connectionString: process.env.DATABASE_URL });
            client.connect()
              .then(() => console.log('Database connection successful'))
              .then(() => client.query('SELECT version()'))
              .then(res => console.log('PostgreSQL version:', res.rows[0].version))
              .catch(err => console.error('Database connection failed:', err))
              .finally(() => client.end());
          " || echo "Database check completed with warnings"
        env:
          DATABASE_URL: ${{ secrets.DATABASE_URL }}
      
      - name: Analyze database performance
        run: |
          cd backend
          node -e "
            const { Client } = require('pg');
            const client = new Client({ connectionString: process.env.DATABASE_URL });
            async function analyzeDB() {
              await client.connect();
              
              // Check table sizes
              const sizesQuery = \`
                SELECT schemaname, tablename, pg_size_pretty(pg_total_relation_size(schemaname||'.'||tablename)) as size
                FROM pg_tables
                WHERE schemaname NOT IN ('information_schema', 'pg_catalog')
                ORDER BY pg_total_relation_size(schemaname||'.'||tablename) DESC
                LIMIT 10;
              \`;
              
              const sizes = await client.query(sizesQuery);
              console.log('Top 10 largest tables:');
              sizes.rows.forEach(row => console.log(\`  \${row.tablename}: \${row.size}\`));
              
              await client.end();
            }
            analyzeDB().catch(console.error);
          " || echo "Database analysis completed with warnings"
        env:
          DATABASE_URL: ${{ secrets.DATABASE_URL }}

  # Cleanup old artifacts and caches
  cleanup:
    name: Cleanup
    runs-on: ubuntu-latest
    if: github.event.schedule || github.event.inputs.task == 'all' || github.event.inputs.task == 'cleanup'
    
    steps:
      - name: Checkout code
        uses: actions/checkout@v4
      
      - name: Cleanup old workflow runs
        uses: actions/github-script@v7
        with:
          script: |
            const runs = await github.rest.actions.listWorkflowRuns({
              owner: context.repo.owner,
              repo: context.repo.repo,
              workflow_id: 'test.yml',
              per_page: 100,
              status: 'completed'
            });
            
            // Keep last 20 runs, delete older ones
            const runsToDelete = runs.data.workflow_runs.slice(20);
            
            for (const run of runsToDelete) {
              if (run.created_at < new Date(Date.now() - 30 * 24 * 60 * 60 * 1000)) { // 30 days old
                console.log(`Deleting workflow run ${run.id} from ${run.created_at}`);
                try {
                  await github.rest.actions.deleteWorkflowRun({
                    owner: context.repo.owner,
                    repo: context.repo.repo,
                    run_id: run.id
                  });
                } catch (error) {
                  console.log(`Could not delete run ${run.id}: ${error.message}`);
                }
              }
            }
      
      - name: Cleanup Docker images
        run: |
          echo "Cleanup would remove old Docker images from registry"
          # docker system prune -af --filter "until=72h"
          echo "Docker cleanup completed"
      
      - name: Cleanup test artifacts
        run: |
          echo "Cleaning up old test artifacts..."
          find . -name "*.log" -mtime +7 -delete || true
          find . -name "coverage" -type d -mtime +7 -exec rm -rf {} + || true
          find . -name "test-results" -type d -mtime +7 -exec rm -rf {} + || true
          echo "Test artifact cleanup completed"

  # Generate maintenance summary
  maintenance-summary:
    name: Maintenance Summary
    runs-on: ubuntu-latest
    needs: [dependency-update, security-scan, performance-check, database-maintenance, cleanup]
    if: always()
    
    steps:
      - name: Generate maintenance report
        run: |
          echo "# Maintenance Report" > maintenance-summary.md
          echo "Generated on: $(date)" >> maintenance-summary.md
          echo "" >> maintenance-summary.md
          echo "## Task Results" >> maintenance-summary.md
          echo "| Task | Status |" >> maintenance-summary.md
          echo "|------|--------|" >> maintenance-summary.md
          echo "| Dependency Update | ${{ needs.dependency-update.result == 'success' && 'âœ…' || 'âŒ' }} ${{ needs.dependency-update.result }} |" >> maintenance-summary.md
          echo "| Security Scan | ${{ needs.security-scan.result == 'success' && 'âœ…' || 'âŒ' }} ${{ needs.security-scan.result }} |" >> maintenance-summary.md
          echo "| Performance Check | ${{ needs.performance-check.result == 'success' && 'âœ…' || 'âŒ' }} ${{ needs.performance-check.result }} |" >> maintenance-summary.md
          echo "| Database Maintenance | ${{ needs.database-maintenance.result == 'success' && 'âœ…' || 'âŒ' }} ${{ needs.database-maintenance.result }} |" >> maintenance-summary.md
          echo "| Cleanup | ${{ needs.cleanup.result == 'success' && 'âœ…' || 'âŒ' }} ${{ needs.cleanup.result }} |" >> maintenance-summary.md
          
          cat maintenance-summary.md >> $GITHUB_STEP_SUMMARY
      
      - name: Upload maintenance report
        uses: actions/upload-artifact@v3
        with:
          name: maintenance-report
          path: maintenance-summary.md
          retention-days: 90
      
      - name: Notify team of maintenance completion
        uses: 8398a7/action-slack@v3
        if: always()
        with:
          status: custom
          custom_payload: |
            {
              text: "ðŸ”§ Scheduled maintenance completed",
              attachments: [{
                color: '${{ needs.security-scan.result == 'success' && needs.performance-check.result == 'success' && 'good' || 'warning' }}',
                fields: [
                  {
                    title: "Dependency Updates",
                    value: "${{ needs.dependency-update.result }}",
                    short: true
                  },
                  {
                    title: "Security Scan",
                    value: "${{ needs.security-scan.result }}",
                    short: true
                  },
                  {
                    title: "Performance Check",
                    value: "${{ needs.performance-check.result }}",
                    short: true
                  },
                  {
                    title: "Database Maintenance",
                    value: "${{ needs.database-maintenance.result }}",
                    short: true
                  }
                ]
              }]
            }
        env:
          SLACK_WEBHOOK_URL: ${{ secrets.SLACK_WEBHOOK_URL }}