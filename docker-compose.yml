services:
  # VPN Gateway - All other services route through this
  gluetun:
    image: qmcgaw/gluetun:latest
    container_name: homeops-gluetun
    restart: unless-stopped
    cap_add:
      - NET_ADMIN
    devices:
      - /dev/net/tun:/dev/net/tun
    ports:
      # Pi-hole DNS ports through VPN
      - "53:53/tcp"
      - "53:53/udp"
      - "8081:80/tcp"     # Pi-hole admin interface (changed from 8080 to avoid conflict)
      # Redis through VPN
      - "6380:6379"  # Changed from 6379 to avoid conflict with local Redis
      # TimescaleDB through VPN
      - "5433:5432"       # Different port to avoid conflict with Supabase
      # Gluetun control server
      - "8000:8000"
    volumes:
      - ./docker/gluetun:/gluetun
    environment:
      # VPN Configuration - Updated for NordVPN
      - VPN_SERVICE_PROVIDER=nordvpn
      - VPN_TYPE=openvpn
      - OPENVPN_USER=${NORDVPN_USERNAME}
      - OPENVPN_PASSWORD=${NORDVPN_PASSWORD}
      - SERVER_COUNTRIES=${NORDVPN_COUNTRY}
      - SERVER_CATEGORIES=P2P
      - OPENVPN_PROTOCOL=udp
      # Network Configuration
      - FIREWALL=on
      - FIREWALL_VPN_INPUT_PORTS=53,80,6379,5432,8000
      - FIREWALL_INPUT_PORTS=53,80,6379,5432,8000
      - DOT=off
      - DNS=1.1.1.1,8.8.8.8
      # Health check
      - HEALTH_VPN_DURATION_INITIAL=30s
      - HEALTH_VPN_DURATION_ADDITION=10s
    healthcheck:
      test: ["CMD", "curl", "-f", "http://localhost:8000/health"]
      interval: 30s
      timeout: 10s
      retries: 3
      start_period: 30s
    labels:
      - "homeops.service=vpn"
      - "homeops.priority=critical"
      - "homeops.health_url=http://localhost:8000/health"
    networks:
      - homeops-network

  # DNS Server - Pi-hole for network-wide ad blocking
  pihole:
    image: pihole/pihole:latest
    container_name: homeops-pihole
    restart: unless-stopped
    depends_on:
      gluetun:
        condition: service_healthy
    network_mode: "service:gluetun"
    volumes:
      - ./docker/pihole/etc:/etc/pihole
      - ./docker/pihole/dnsmasq:/etc/dnsmasq.d
    environment:
      - TZ=America/New_York
      - WEBPASSWORD=${PIHOLE_ADMIN_PASSWORD:-admin123}
      - PIHOLE_DNS_1=1.1.1.1
      - PIHOLE_DNS_2=8.8.8.8
      - DNSMASQ_LISTENING=all
      - WEB_PORT=80
      - FTLCONF_LOCAL_IPV4=0.0.0.0
      - VIRTUAL_HOST=pihole.homeops.local
      - IPv6=false
    healthcheck:
      test: ["CMD", "dig", "@127.0.0.1", "google.com"]
      interval: 30s
      timeout: 10s
      retries: 3
    labels:
      - "homeops.service=dns"
      - "homeops.priority=high"
      - "homeops.health_url=http://localhost/admin"

  # Backend API service - commented out for now, running separately
  # backend:
  #   build:
  #     context: ./backend
  #     dockerfile: ../Dockerfile.backend
  #   container_name: homeops-backend
  #   depends_on:
  #     - gluetun
  #     - redis
  #   network_mode: "service:gluetun"
  #   volumes:
  #     - ./backend:/app
  #     - /app/node_modules
  #   environment:
  #     - NODE_ENV=${NODE_ENV:-development}
  #     - PORT=3001
  #     - DATABASE_URL=${DATABASE_URL}
  #     - SUPABASE_URL=${SUPABASE_URL}
  #     - SUPABASE_ANON_KEY=${SUPABASE_ANON_KEY}
  #     - SUPABASE_SERVICE_KEY=${SUPABASE_SERVICE_KEY}
  #     - REDIS_URL=redis://localhost:6379
  #     - JWT_SECRET=${JWT_SECRET}
  #   restart: unless-stopped

  # Redis Cache - Session storage and caching
  redis:
    image: redis:7-alpine
    container_name: homeops-redis
    restart: unless-stopped
    depends_on:
      gluetun:
        condition: service_healthy
    network_mode: "service:gluetun"
    volumes:
      - redis_data:/data
      - ./docker/redis/redis.conf:/usr/local/etc/redis/redis.conf
    command: redis-server /usr/local/etc/redis/redis.conf --appendonly yes
    environment:
      - REDIS_PASSWORD=${REDIS_PASSWORD:-homeops123}
    healthcheck:
      test: ["CMD", "redis-cli", "--raw", "incr", "ping"]
      interval: 30s
      timeout: 10s
      retries: 3
    labels:
      - "homeops.service=cache"
      - "homeops.priority=medium"

  # TimescaleDB - Time-series metrics storage
  timescaledb:
    image: timescale/timescaledb:latest-pg15
    container_name: homeops-timescaledb
    restart: unless-stopped
    depends_on:
      gluetun:
        condition: service_healthy
    network_mode: "service:gluetun"
    volumes:
      - timescale_data:/var/lib/postgresql/data
      - ./docker/timescaledb/init:/docker-entrypoint-initdb.d
    environment:
      - POSTGRES_DB=${TIMESCALE_DB}
      - POSTGRES_USER=${TIMESCALE_USER}
      - POSTGRES_PASSWORD=${TIMESCALE_PASSWORD}
      - TIMESCALEDB_TELEMETRY=off
    healthcheck:
      test: ["CMD-SHELL", "pg_isready -U ${TIMESCALE_USER} -d ${TIMESCALE_DB}"]
      interval: 30s
      timeout: 10s
      retries: 3
    labels:
      - "homeops.service=metrics"
      - "homeops.priority=medium"

  # Portainer - Docker container management UI
  portainer:
    image: portainer/portainer-ce:latest
    container_name: homeops-portainer
    restart: unless-stopped
    ports:
      - "9000:9000"
    volumes:
      - /var/run/docker.sock:/var/run/docker.sock
      - portainer_data:/data
    environment:
      - VIRTUAL_HOST=portainer.homeops.local
    healthcheck:
      test: ["CMD", "curl", "-f", "http://localhost:9000/api/status"]
      interval: 30s
      timeout: 10s
      retries: 3
    labels:
      - "homeops.service=management"
      - "homeops.priority=low"
    networks:
      - homeops-network

volumes:
  redis_data:
    driver: local
    driver_opts:
      type: none
      o: bind
      device: ./docker/data/redis
  
  timescale_data:
    driver: local
    driver_opts:
      type: none
      o: bind
      device: ./docker/data/timescaledb
  
  portainer_data:
    driver: local

networks:
  homeops-network:
    name: homeops-network
    driver: bridge
    ipam:
      config:
        - subnet: 172.20.0.0/16